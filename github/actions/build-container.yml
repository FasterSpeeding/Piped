name: "Build a container"
description: "Build a container"  

inputs:
  architecture:
    description: "The architecture to build the container for"
    required: false
    default: ""
  containerfiles:
    description: "Links to the containerfiles to build"
    required: false
    default: |
      ./Containerfile
  container_build_context:
    description: "The directory to pass through as the working directory during container builds"
    required: false
    default: {{ CONTAINER_BUILD_CONTEXT }}
  image-name:
    description: "The built image's name"
    required: false
    default: {% raw %}${{ github.repository }}{% endraw %}
  keep-image:
    description: "Whether to keep a local copy of the image"
    required: false
    default: "./"
  registry:
    description: "Registry the built image is for"
    required: false
    default: ghcr.io

outputs:{% raw %}
  image:
    description: "Name of the image built"
    value: ${{ steps.build.outputs.image }}
  image-artifact-id:
    description: "Name of the artifact holding the built iamge"
    value: ${{ steps.upload-coverage.outputs.artifact-id }}
  image-artifact-url:
    description: "Name of the artifact holding the built iamge"
    value: ${{ steps.upload-coverage.outputs.artifact-url }}
  image-artifact-digest:
    description: "Name of the artifact holding the built iamge"
    value: ${{ steps.upload-coverage.outputs.artifact-digest }}
  tags:
    description: "List of the tags that were created, separated by spaces"
    value: ${{ steps.build.outputs.tags }}
  image-with-tag:
    description: "Name of the image tagged with the first tag present"
    value: ${{ steps.build.outputs.image-with-tag }}{% endraw %}

runs:
  using: composite

  steps:
    - name: Maximize build space
      if: inputs.keep-image == 'true'
      uses: ublue-os/remove-unwanted-software@cc0becac701cf642c8f0a6613bbdaf5dc36b259e # v9

    - name: Install Crane
      uses: iarekylew00t/crane-installer@af22986e01a08365e8b29e45e5a336c7995c111b # v4.0.0

    - name: Install QEMU
      if: inputs.architecture != ''
      uses: docker/setup-qemu-action@29109295f81e9208d7d86ff1c6c12d2833863392 # v3.6.0
      with:
        platforms: {% raw %}${{ inputs.architecture }}{% endraw %}

    - name: Generate build configuration
      id: gen-config
      shell: bash
      run: |{% raw %}
        if [[ -n ${{ inputs.architecture }} ]]; then
          architecture="${{ inputs.architecture }}"
          platform="linux/${{ inputs.architecture }}"
        else
          platform="$(podman info -f {{.Version.OsArch}})"
          architecture="$(echo '${{ inputs.architecture }}' | cut -d '/' -f2)"
        fi

        echo "architecture=$architecture" >> GITHUB_OUTPUT
        echo "platform=$platform" >> GITHUB_OUTPUT
        echo "tag=${{ inputs.image-name }}-${{ inputs.architecture }}-$(uuid-gen)" >> GITHUB_OUTPUT{% endraw %}

    - name: Generate container metadata
      id: metadata
      uses: docker/metadata-action@c1e51972afc2121e065aed6d45c65596fe445f3f # v5.8.0
      with:
        images: {% raw %}${{ inputs.REGISTRY }}/${{ inputs.IMAGE_NAME }}{% endraw %}
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
          type=sha

    - name: Build image
      id: build
      uses: redhat-actions/buildah-build@7a95fa7ee0f02d552a32753e7414641a04307056 # v2.13
      with:{% raw %}
        oci: true
        image: ${{ inputs.image-name }}
        tags: ${{ steps.gen-config.outputs.tag }}
        labels: ${{ steps.metadata.outputs.labels }}
        platforms: ${{ steps.gen-config.outputs.platform }}
        containerfiles: ${{ inputs.containerfiles }}
        context: ${{ inputs.container_build_context }}{% endraw %}

    - name: Save image
      id: save
      shell: bash
      run: |{% raw %}
        OUTPUT_DIR="${{ env.RUNNER_TEMP }}/oci-images/"
        OUTPUT_PATH="$OUTPUT_DIR/${{ steps.gen-config.outputs.tag }}.oci"

        mkdir -p "$OUTPUT_DIR"
        crane pull "$IMAGE" "$OUTPUT_PATH" --annotate-ref --format oci

        echo "image_dir=$OUTPUT_DIR" >> "$GITHUB_OUTPUT"
        echo "image_path=$OUTPUT_PATH" >> "$GITHUB_OUTPUT"{% endraw %}

    - name: Create coverage artifacts
      id: upload-coverage
      uses: actions/upload-artifact@de65e23aa2b7e23d713bb51fbfcb6d502f8667d8
      with:{% raw %}
        name: container-build-${{ inputs.image-name }}-${{ inputs.architecture }}
        path: ${{ steps.save.outputs.image_dir }}/*.oci
        if-no-files-found: error
        retention-days: 1{% endraw %}

    - name: Clear local store
      shell: bash
      run: |{% raw %}
        rm ${{ steps.save.outputs.image_path }}

        if [[ keep-image == "false" ]]; then
          podman image rm ${{ steps.build.outputs.image-with-tag }}
        fi{% endraw %}
